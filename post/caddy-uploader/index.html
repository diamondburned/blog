<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
			
				<meta name="description" content="Making an image uploader and browser server with the cleanest stack ever">
			
		
	
		
			<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
	function loadgitment() {
		window.gitment = new Gitment({
			id: "",
			owner: "diamondburned",
			repo: "blog",
			oauth: {
				client_id: "13865af1e100e15551ff",
				client_secret: "7fc933a656f0a9311d7421b5859d657cd4648531",
			},
		});
		
		window.gitment.render(document.querySelector('#gitment'));
	}
</script>
			<style>
h2.cmt-header {
	padding: .5em;
}
div#gitment {
	padding: 1em;
	padding-top: 0;
	margin-top: -1em;
}
.gitment-container * {
	color: #AAAAAA;  
}
.gitment-comment-main, .gitment-editor-main {
	border: 0;
	background: rgba(0,0,0,0.25);
	padding: .5em
}
.gitment-comment-header {
	background: none;
	border-radius: 0px;
	color: #CCC;
	margin: 0 .5em;
}
.gitment-comment-body {
	margin: 0 .5em;
	border-radius: 0px;
}
.gitment-heart-icon, path.gitment-heart-icon {
	fill: #CCC;
}
.gitment-editor-main::before, .gitment-comment-main::before {
	border-right-color: rgba(0,0,0,0.25);
}
.gitment-editor-main::after, .gitment-comment-main::after {
	border-right-color: transparent;
}
.gitment-editor-body textarea, .gitment-editor-body textarea:focus, .gitment-editor-preview.gitment-markdown {
	box-shadow: inset 0px 0px 3px rgba(0,0,0,0.75);
	background-color: #0E0E0E;
	color: #CCC;
	line-height: 1.4;
}
.gitment-editor-tab {
	margin-left: 1px;
}
.gitment-editor-tab.gitment-selected {
	background-color: rgba(0,0,0,0.25);
	border-color: transparent;
	border-bottom: none;
	color: #CCC;
}
.gitment-editor-header {
	border-bottom: transparent;
}
.gitment-editor-submit, .gitment-comments-init-btn {
	background-color: rgba(255,255,255,0.05);
	color: #CCC;
}
.gitment-editor-submit:hover, .gitment-comments-init-btn:hover {
	background-color: rgba(255,255,255,0.15);
}
a.gitment-editor-footer-tip {
	display: none;
}
.gitment-editor-login {
	margin-top: -45px;
	margin-right: 5px;
}
.gitment-comment-avatar, .gitment-comment-avatar-img, .gitment-comment-avatar, .gitment-editor-avatar-img, .gitment-editor-avatar svg {
	border-radius: 50%;
	background: black;
}
.gitment-footer-container {
	margin-top: -20px;
	margin-bottom: 0px;
}
</style>
		
		
		<title>
			
				Image uploader/browser with only Caddy &middot; diamondburned&#39;s stupid blog posts
			
		</title>
	
		
		<style>
* {
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
    line-height: 1.65rem
}
html, body {
    color: #aaa;
    margin: 0;
    padding: 0
}
html {
    font-family: sans-serif, "Noto Color Emoji", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    font-size: 1rem;
    overflow-y: scroll;
    background: #171717;
}
body {
    -webkit-text-size-adjust: 100%;
    max-width: 800px;
    width: 100vw;
    margin: 0px auto;
    background: #1d1d1d;
    min-height: 100vh;
    padding-bottom: 60px;
    position: relative;
    box-shadow: 0px 0px 5px 2px rgba(0,0,0,0.5);
}
h1, h2, h3, h4, h5, h6 {
    color: #AAAAAA;
    line-height: normal;
    margin-bottom: 0.5em;
    margin-top: 1em;
}
a {
    color: #FFFFFF;
    text-decoration: none;
}
blockquote {
    border-left: .25rem solid #1a1a1a;
    color: #686868;
    margin: .8rem 0;
    padding: .5rem 1rem
}
blockquote p:last-child {
    margin-bottom: 0
}
img {
    display:block;
    margin:0 0 1rem;
    max-width:100%
}
td {
    vertical-align:top
}
pre, code {
    font-family: "Noto Mono", monospace;
}
code {
    background-color:#0E0E0E;
    border-radius:3px;
    color:#409e95;
    font-size: 0.9em;
    padding: .1em .25em;
    box-shadow: inset 0px 0px 3px rgba(0,0,0,0.75);
}
pre {
    margin:0 0 1rem;
    word-wrap: break-word;
    white-space: pre-wrap;
    background-color: #0E0E0E;
    padding: 1em;
    border-radius: 10px;
    box-shadow: inset 0px 0px 10px rgba(0,0,0,0.75);
}
pre code {
    background-color:transparent;
    font-size:0.9em;
    padding:0;
    box-shadow: none;
}
.highlight {
    background-color:#060606;
    border-radius:3px;
    line-height:1.4;
    margin:0 0 1rem;
    padding:1rem
}
.highlight pre {
    margin-bottom:0;
    overflow-x:auto
}
.highlight .lineno {
    color:#555;
    display:inline-block;
    padding:0 .75rem 0 .25rem;
    -webkit-user-select:none;
    -moz-user-select:none;
    user-select:none
}
.post {
    padding: 1em
}
.post-info {
    color:#555;
    letter-spacing:.5px;
    text-align:center
}
.post-info span {
    font-style:italic
}
.post-title {
    color:#aaaaaa;
    font-size:3rem;
    margin:1rem 0;
    text-align:center
}
.post-line {
    border-top: 2px solid rgba(255,255,255,0.5);
    display:block;
    margin: 0 auto 1rem;
    width:50%;
}
.post p {
    margin:0 0 1rem;
    text-align:justify
}
.post a:hover {
    text-decoration:underline
}
.post img {
    margin:0 auto .5rem
}
.post img + em {
    color:#555;
    display:block;
    font-size:1rem;
    font-style:normal;
    text-align:center
}
.post img.emoji {
    display:inline-block;
    left:0;
    transform:none;
    width:1rem;
    height:1rem;
    vertical-align:text-top;
    padding:0;
    margin:0
}
.highlight .hll {
    background-color:#ffc
}
.highlight .c {
    color:#999
}
.highlight .err {
    color:#a00;
    background-color:#faa
}
.highlight .k {
    color:#069
}
.highlight .o {
    color:#555
}
.highlight .cm {
    color:#09f;
    font-style:italic
}
.highlight .cp {
    color:#099
}
.highlight .c1 {
    color:#999
}
.highlight .cs {
    color:#999
}
.highlight .gd {
    background-color:#fcc;
    border:1px solid #c00
}
.highlight .ge {
    font-style:italic
}
.highlight .gr {
    color:red
}
.highlight .gh {
    color:#030
}
.highlight .gi {
    background-color:#cfc;
    border:1px solid #0c0
}
.highlight .go {
    color:#aaa
}
.highlight .gp {
    color:#009
}
.highlight .gu {
    color:#030
}
.highlight .gt {
    color:#9c6
}
.highlight .kc {
    color:#069
}
.highlight .kd {
    color:#069
}
.highlight .kn {
    color:#069
}
.highlight .kp {
    color:#069
}
.highlight .kr {
    color:#069
}
.highlight .kt {
    color:#078
}
.highlight .m {
    color:#f60
}
.highlight .s {
    color:#d44950
}
.highlight .na {
    color:#4f9fcf
}
.highlight .nb {
    color:#366
}
.highlight .nc {
    color:#0a8
}
.highlight .no {
    color:#360
}
.highlight .nd {
    color:#99f
}
.highlight .ni {
    color:#999
}
.highlight .ne {
    color:#c00
}
.highlight .nf {
    color:#c0f
}
.highlight .nl {
    color:#99f
}
.highlight .nn {
    color:#0cf
}
.highlight .nt {
    color:#2f6f9f
}
.highlight .nv {
    color:#033
}
.highlight .ow {
    color:#000
}
.highlight .w {
    color:#bbb
}
.highlight .mf {
    color:#f60
}
.highlight .mh {
    color:#f60
}
.highlight .mi {
    color:#f60
}
.highlight .mo {
    color:#f60
}
.highlight .sb {
    color:#c30
}
.highlight .sc {
    color:#c30
}
.highlight .sd {
    color:#c30;
    font-style:italic
}
.highlight .s2 {
    color:#c30
}
.highlight .se {
    color:#c30
}
.highlight .sh {
    color:#c30
}
.highlight .si {
    color:#a00
}
.highlight .sx {
    color:#c30
}
.highlight .sr {
    color:#3aa
}
.highlight .s1 {
    color:#c30
}
.highlight .ss {
    color:#fc3
}
.highlight .bp {
    color:#366
}
.highlight .vc {
    color:#033
}
.highlight .vg {
    color:#033
}
.highlight .vi {
    color:#033
}
.highlight .il {
    color:#f60
}
.css .o, .css .o + .nt, .css .nt + .nt {
    color:#999
}
.container {
    margin:0 auto;
    max-width:800px;
    width:80%
}
footer, .nav-container {
    display:block;
    margin:0 auto;
    max-width:800px;
    width:80%;
    padding: 0 .5em;
}
main {
    max-width: 800px;
    width: 100vw;
    padding: 0 .5em;
}
.if-nav-fixed {
    height: 0px;
}
.nav {
    box-shadow: 0 0px .5px 0px rgba(255, 255, 255, 0.5);
    overflow:auto;
    min-height: 65px;
    background: #1d1d1d;
    z-index: 1;
}
.nav-container {
    margin: 1em auto;
    width: 100%;
    position:relative;
    display: inline-table;
}
.title, .menu {
    display: inline;
    margin: 0 1em;
}
.title {
    float: left;
    display:table-cell;
    vertical-align:middle   
}
.menu {
    float: right;
    display:table-cell;
    vertical-align:middle   
}
.nav-title {
    -webkit-transition:all .2s ease-out;
    -moz-transition:all .2s ease-out;
    transition:all .2s ease-out;
    color:#AAA;
    display:inline-block;
    margin:0;
    padding-right:.2rem
}
.nav-title:hover, .nav-title:focus {
    opacity:.6
}
h2.nav-title {
}
.nav ul {
    list-style-type:none;
    margin: 0;
    line-height: 1.5;
    padding:0;
}
.nav li {
    -webkit-transition:all .2s ease-out;
    -moz-transition:all .2s ease-out;
    transition:all .2s ease-out;
    color:#aaa;
    display:inline-block;
    opacity:.6;
    padding:0 2rem 0 0
}
.nav li:last-child {
    padding-right:0
}
.nav li:hover, .nav li:focus {
    opacity:1
}
.nav a {
    color:#aaa;
}
footer {
    position: absolute;
    bottom: 0;
    height: 24px;
    padding: 3em 0;
    text-align: center;
    max-width: 500px;
    width: 100vw;
    margin: 0 auto;
    bottom: 1em;
    left: 0;
    right: 0;
}
footer span {
    color:#aaa;
    font-size:.8rem
}
p.footer {
    margin: 0;
}
.pagination {
    border-top: .5px solid transparent;
    position: absolute;
    text-align: center;
    max-width: 500px;
    width: 100vw;
    margin: 0 auto;
    bottom: 4em;
    left: 0;
    right: 0;
}
.pagination span {
    color:#aaaaaa;
    font-size:1.1rem
}
.pagination .top {
    -webkit-transition:all .3s ease-out;
    -moz-transition:all .3s ease-out;
    transition:all .3s ease-out;
    color:#aaa;
    font-size:1.1rem;
    opacity:.6
}
.pagination .top:hover {
    opacity:1
}
.pagination .arrow {
    -webkit-transition:all .3s ease-out;
    -moz-transition:all .3s ease-out;
    transition:all .3s ease-out;
    color:#aaa;
    position:absolute
}
.pagination .arrow:hover, .pagination .arrow:focus {
    opacity:.6;
    text-decoration:none
}
.pagination .left {
    left:0
}
.pagination .right {
    right:0
}
.catalogue-item {
    border-bottom:1px solid #1a1a1a;
    color:#aaa;
    display:inline-block;
    padding: 1rem 1rem 2rem;
}
.catalogue-item:hover .catalogue-line, .catalogue-item:focus .catalogue-line {
    width:5rem
}
.catalogue-item:last-child {
    border:0
}
.catalogue-time {
    color:#555;
    letter-spacing:.5px;
    font-family: "Noto Mono", monospace;
}
.catalogue-title {
    color:#aaaaaa;
    display:block;
    font-size:2rem;
    font-weight:700;
    margin: 0;
    margin-bottom :.5rem 
}
.catalogue-line {
    -webkit-transition:all .3s ease-out;
    -moz-transition:all .3s ease-out;
    transition:all .3s ease-out;
    border-top:.2rem solid #aaaaaa;
    display:block;
    width:2rem
}
.fab {
    font-weight: 500 !important;
}
</style>
		
			
				<style> 
					html { 
						font-family: "Source Sans Pro","Noto Sans","Helvetica","Segoe UI",
								sans-serif, "Noto Color Emoji", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol" 
					} 
				</style>
			
			
			
			
				<style>
					.nav {position: fixed; max-width: 800px; width: 100vw;}
					.if-nav-fixed {max-height: 12vh; height: 8vw;}
					@media only screen and (max-width: 600px) { .if-nav-fixed {max-height: 22vh; height: 18vh;} }
				</style>
			
			
			
				<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
			
		
		<link rel="icon" href="/images/icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="diamondburned&#39;s stupid blog posts" />

		
	</head>
		

	<body onload="loadgitment()">
		<nav class="nav">
			<div class="nav-container">
				<div class="title">
					<a href="https://blog.diamondb.xyz/">
						<h2 class="nav-title">diamondburned&#39;s stupid blog posts</h2>
					</a>
				</div>
				<div class="menu"><h2 class="nav-title">
					<ul>
						<li><a href="https://blog.diamondb.xyz">
							<i class="fas fa-home"></i>
						</a></li>
						<li><a href="https://diamondb.xyz/">
							<i class="fas fa-info-circle"></i>
						</a></li>
						
						
							<li><a href="https://gitlab.com/diamondburned">
								<i class="fab fa-gitlab"></i>
							</a></li>
						
						
							<li><a href="mailto:diamondburned@diamondb.xyz">
								<i class="fas fa-envelope"></i>
							</a></li>
						
						
					</ul>
				</h2></div>
			</div>
		</nav>
		<div class="if-nav-fixed"></div>

<main>
	<div class="post">
		<div class="post-info">
		<span>Written by</span>
		
			diamondburned
		

		
			<br>
			<span>on&nbsp;</span><time datetime="2019-11-10 10:56:17 -0800 PST">November 10, 2019</time>
		
		</div>

		<h1 class="post-title">Image uploader/browser with only Caddy</h1>
		<div class="post-line"></div>

		

<h2 id="prelude">Prelude</h2>

<p>Recently a lot of people have been asking me about setting up a file server, mainly to serve their screenshots. As I have helped one of my friends set up his, I will put that into a clean guide in this blog post.</p>

<h2 id="why-caddy">Why Caddy?</h2>

<p>When people asked me about methods to do this, they always get creative. Some thought an <code>rsync</code> + NGINX stack would be nice, others suggested a Node.JS application to go along. One even suggested me to use PHP applications with Apache.</p>

<p>So why Caddy? Caddy acts as a web server, similarly to NGINX. However, it has Let&rsquo;s Encrypt built in, no longer needing <code>certbot</code>. It has WebDAV as a clean extension, no longer needing any PHP/Node.JS application as an uploader. Finally, Caddy has a clean and small config syntax.</p>

<h2 id="requirements">Requirements</h2>

<p>In this blog post (guide), I&rsquo;ll assume the target server runs on Ubuntu, which means it would use systemd for service management. Obviously, if the target server runs on NixOS, things would&rsquo;ve been easier.</p>

<p>Some more obvious requirements would be an internet connection, a domain, and a static IP.</p>

<h3 id="precaution">Precaution</h3>

<p>This guide assumes installation into the user home directory, not the system directory. If your server hosts multiple web applications on different users, this guide is <em>not</em> for you.</p>

<h2 id="1-creating-the-folders-needed">1. Creating the folders needed</h2>

<pre><code class="language-sh">mkdir ~/Pictures # The directory that pictures will go, our www root
</code></pre>

<h2 id="2-getting-caddy">2. Getting Caddy</h2>

<pre><code class="language-sh"># Since we need a Caddy with WebDAV for file uploads, we'll install Caddy with
# WebDAV. This script should put Caddy in /usr/bin.
curl https://getcaddy.com | bash -s personal http.webdav
</code></pre>

<h2 id="3-setting-up-caddy-as-a-systemd-service">3. Setting up Caddy as a systemd service</h2>

<p>This file goes to <code>/etc/systemd/system/caddy.service</code>. <strong>Replace properties underneath &ldquo;REPLACE ME&rdquo;</strong> for this to work.</p>

<pre><code class="language-ini">[Unit]
Description=Caddy HTTP/2 web server
Documentation=https://caddyserver.com/docs
After=network-online.target
Wants=network-online.target

[Service]
;REPLACE ME
User=$username
Group=$groupname
WorkingDirectory=/home/$username
ReadWriteDirectories=/home/$username
Environment=CADDYPATH=./.caddy

;Do not change these
ExecStart=/usr/local/bin/caddy -log stderr -agree=true -conf=./Caddyfile -root=./.caddy
ExecReload=/bin/kill -USR1 $MAINPID
Restart=on-failure
LimitNOFILE=1048576
</code></pre>

<h3 id="reloading-systemd-services">Reloading systemd services</h3>

<pre><code class="language-sh">sudo systemctl daemon-reload
</code></pre>

<h2 id="4-configure-caddy">4. Configure Caddy</h2>

<p>For this section, we&rsquo;ll assume your domain is <code>example.com</code>. <code>i.example.com</code> would serve images, which would be CloudFlare protected. <code>d.example.com</code> would not be CloudFlare protected, as <a href="https://github.com/cloudflare/cloudflared/issues/69">CloudFlare breaks WebDAV</a>.</p>

<p>This file goes to <code>~/Caddyfile</code>. <strong>Replace variables such as</strong> <code>$username</code> for this to work. This username and password is only used for uploading.</p>

<pre><code>i.example.com {
    root ./Pictures
    gzip
    browse
}

d.example.com {
    basicauth / $username $password
    webdav / {
       scope ./Pictures/
    }
}
</code></pre>

<h2 id="5-start-caddy-up">5. Start Caddy up</h2>

<pre><code class="language-sh">sudo systemctl start caddy
</code></pre>

<h2 id="testing-caddy">Testing Caddy</h2>

<p>At this point, <code>i.example.com</code> should return you a webpage under HTTPS.</p>

<h2 id="troubleshooting-caddy">Troubleshooting Caddy</h2>

<p>To access Caddy logs, do <code>sudo journalctl -u caddy</code>.</p>

<h2 id="uploading-screenshots">Uploading screenshots</h2>

<h3 id="curl-example-username-and-password"><code>curl</code> example - <code>$username</code> and <code>$password</code></h3>

<pre><code class="language-sh">curl --basic --user &quot;$username:$password&quot; -T $FILE_PATH https://d.example.com/
</code></pre>

<p>More advanced usages at <a href="https://code.blogs.iiidefix.net/posts/webdav-with-curl/">https://code.blogs.iiidefix.net/posts/webdav-with-curl/</a></p>

<h3 id="sharex-username-and-password">ShareX - <code>&lt;username&gt;</code> and <code>&lt;password&gt;</code></h3>

<pre><code class="language-json">{
  &quot;DestinationType&quot;: &quot;ImageUploader, FileUploader&quot;,
  &quot;RequestMethod&quot;: &quot;PUT&quot;,
  &quot;RequestURL&quot;: &quot;https://d.example.com/$filename$&quot;,
  &quot;Body&quot;: &quot;Binary&quot;,
  &quot;Headers&quot;: {
    &quot;Authorization&quot;: &quot;Basic $base64:&lt;username&gt;:&lt;password&gt;$&quot;
  },
  &quot;URL&quot;: &quot;https://i.example.com/$filename$&quot;
}
</code></pre>


	</div>

	
		<h2 class="cmt-header">Comments</h2>
<div id="gitment">
	
</div>
		<noscript>JavaScript is required for comments to show.</noscript>
	
</main>

<div class="pagination">
	
	
	<a href="/post/thoughts-on-gitment-and-my-hugo-theme/" class="right arrow">&#8594;</a>
	

	<a href="#" class="top">Top</a>
</div>
		<footer>
			<span>
				<p class="footer">Discord: <code>_diamondburned_#4507</code></p>
				
  					
  						<p class="footer credits">
  							<a href="https://gitlab.com/diamondburned/burned/">Theme made by diamondburned</a>, powered by <a href="https://gohugo.io/">Hu<strong>go</strong></a>
  						</p>
  					
  				
			</span>
		</footer>
  </body>
</html>